<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dorakdorak.domain.order.mapper.OrderMapper">

    <select id="findNormalOrdersByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderResponseDto">
        SELECT
            ID AS ORDER_ID,
            ORDER_CODE,
            CREATED_AT AS ORDER_DATE
        FROM ORDERS
        WHERE MEMBER_ID = #{memberId}
            AND IS_GONGGOO = 'NORMAL'
        ORDER BY CREATED_AT DESC
    </select>

    <select id="findNormalOrdersPreviewByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderPreviewResponseDto">
        SELECT
            NAME,
            IMAGE_URL,
            PRICE,
            AMOUNT,
            ORDER_DATE
        FROM (
            SELECT
                OI.NAME AS NAME,
                OI.IMAGE_URL AS IMAGE_URL,
                OI.PRICE AS PRICE,
                COUNT(*) AS AMOUNT,
                MAX(OI.CREATED_AT) AS ORDER_DATE,
                OI.ORDER_STATUS AS ORDER_STATUS
            FROM ORDER_ITEMS OI
                JOIN ORDERS O ON OI.ORDER_ID = O.ID
            WHERE O.MEMBER_ID = #{memberId}
                AND O.IS_GONGGOO = 'NORMAL'
            GROUP BY OI.NAME, OI.IMAGE_URL, OI.PRICE, OI.ORDER_STATUS
            ORDER BY ORDER_DATE DESC
        )
        WHERE ROWNUM &lt;= 3
    </select>

    <select id="findGroupOrdersByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderResponseDto">
        SELECT
            ID AS ORDER_ID,
            ORDER_CODE,
            CREATED_AT AS ORDER_DATE
        FROM ORDERS
        WHERE MEMBER_ID = #{memberId}
        AND IS_GONGGOO = 'GONGGOO'
    </select>

    <select id="findGroupOrdersPreviewByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderPreviewResponseDto">
        SELECT
            NAME,
            IMAGE_URL,
            PRICE,
            AMOUNT,
            ORDER_DATE,
            ORDER_STATUS
        FROM (
            SELECT
                OI.NAME AS NAME,
                OI.IMAGE_URL AS IMAGE_URL,
                OI.PRICE AS PRICE,
                COUNT(*) AS AMOUNT,
                MAX(OI.CREATED_AT) AS ORDER_DATE,
                OI.ORDER_STATUS AS ORDER_STATUS
            FROM ORDER_ITEMS OI
                JOIN ORDERS O ON OI.ORDER_ID = O.ID
            WHERE O.MEMBER_ID = #{memberId}
                AND O.IS_GONGGOO = 'GONGGOO'
            GROUP BY OI.NAME, OI.IMAGE_URL, OI.PRICE, OI.ORDER_STATUS
            ORDER BY ORDER_DATE DESC
        )
        WHERE ROWNUM &lt;= 3
    </select>

    <select id="findItemsByOrderId" resultType="dorakdorak.domain.order.dto.response.MyOrderItemResponseDto">
        SELECT
            NAME,
            IMAGE_URL,
            PRICE,
            COUNT(*) AS AMOUNT,
            ORDER_STATUS
        FROM ORDER_ITEMS
        WHERE ORDER_ID = #{orderId}
        GROUP BY NAME, IMAGE_URL, PRICE, ORDER_STATUS
        ORDER BY MAX(CREATED_AT) DESC
    </select>

    <select id="countNormalOrdersByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderAmountResponseDto">
        SELECT COUNT(*) AS ORDER_AMOUNT
        FROM ORDERS
        WHERE MEMBER_ID = #{memberId}
            AND IS_GONGGOO = 'NORMAL'
    </select>

    <select id="countGroupOrdersByMemberId" resultType="dorakdorak.domain.order.dto.response.MyOrderAmountResponseDto">
        SELECT COUNT(*) AS ORDER_AMOUNT
        FROM ORDERS
        WHERE MEMBER_ID = #{memberId}
            AND IS_GONGGOO = 'GONGGOO'
    </select>

    <select id="getNextOrderId" resultType="long">
        SELECT SEQ_ORDERS.NEXTVAL FROM DUAL
    </select>

    <insert id="insertOrder" parameterType="dorakdorak.domain.order.dto.OrderDto">
        INSERT INTO ORDERS (ID, MEMBER_ID, MERCHANT_ORDER_ID, ORDER_CODE, ORDER_STATUS, PRICE, IS_GONGGOO, ARRIVAL_AT, CREATED_AT, CREATED_BY)
        VALUES (#{id}, #{memberId}, #{merchantOrderId}, #{orderCode}, #{orderStatus}, #{price}, #{isGonggoo}, #{arrivalAt}, SYSTIMESTAMP, #{memberId})
    </insert>

    <insert id="insertOrderItem" parameterType="dorakdorak.domain.order.dto.OrderItemDto">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT SEQ_ORDER_ITEMS.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO ORDER_ITEMS (ID, ORDER_ID, DOSIRAK_ID, NAME, CATEGORY, PRICE, IMAGE_URL, ORDER_STATUS, CREATED_AT, CREATED_BY)
        VALUES (#{id}, #{orderId}, #{dosirakId}, #{name}, #{category}, #{price}, #{imageUrl}, #{orderStatus}, SYSTIMESTAMP, #{createdBy})
    </insert>

    <select id="findByMerchantOrderId" parameterType="string" resultType="dorakdorak.domain.order.dto.OrderDto">
        SELECT ID, MERCHANT_ORDER_ID, MEMBER_ID, ORDER_CODE, ORDER_STATUS, PRICE, IS_GONGGOO, ARRIVAL_AT
        FROM ORDERS
        WHERE MERCHANT_ORDER_ID = #{merchantOrderId}
    </select>

    <update id="updateStatus">
        UPDATE ORDERS
        SET ORDER_STATUS = #{orderStatus}
        WHERE ID = #{id}
    </update>

    <select id="findItemIdsByOrderId" resultType="long">
        SELECT ID
        FROM ORDER_ITEMS
        WHERE ORDER_ID = #{orderId}
    </select>

    <update id="updateOrderItemStatusAndQr">
        UPDATE ORDER_ITEMS
        SET
        ORDER_STATUS = #{orderStatus},
        QRCODE_IMAGE_URL = #{qrImageUrl},
        QRCODE = #{qrToken}
        WHERE ID = #{itemId}
    </update>

    <select id="findById" resultType="dorakdorak.domain.order.dto.OrderDto" parameterType="long">
        SELECT ID, MERCHANT_ORDER_ID, MEMBER_ID, ORDER_CODE, ORDER_STATUS, PRICE, IS_GONGGOO, ARRIVAL_AT
        FROM ORDERS
        WHERE ID = #{orderId}
    </select>

    <select id="findGroupOrdersAll" resultType="dorakdorak.domain.order.dto.GroupOrderDto">
        SELECT
            d.ID AS dosirakId,
            d.NAME AS name,
            d.PRICE AS price,
            (
                SELECT MIN(dc.NAME)
                FROM DOSIRAK_CATEGORY_MAP dcm
                JOIN DOSIRAK_CATEGORY dc ON dcm.DOSIRAK_CATEGORY_ID = dc.ID
                WHERE dcm.DOSIRAK_ID = d.ID
            ) AS category,
            COUNT(oi.ID) AS count
        FROM ORDER_ITEMS oi
            JOIN ORDERS o ON oi.ORDER_ID = o.ID
            JOIN DOSIRAK d ON oi.DOSIRAK_ID = d.ID
        WHERE o.ARRIVAL_AT = #{arrive}
            AND o.UNIVERSITY_ID = #{universityId}
        GROUP BY d.ID, d.NAME, d.PRICE
        ORDER BY d.ID
    </select>

    <select id="findGroupOrdersWithExtra" resultType="dorakdorak.domain.order.dto.GroupOrderDto">
        -- 1. 주문한 도시락 목록
        SELECT
            d.ID AS dosirakId,
            d.NAME AS name,
            d.PRICE AS price,
            (
                SELECT MIN(dc.NAME)
                FROM DOSIRAK_CATEGORY_MAP dcm
                JOIN DOSIRAK_CATEGORY dc ON dcm.DOSIRAK_CATEGORY_ID = dc.ID
                WHERE dcm.DOSIRAK_ID = d.ID
            ) AS category,
            COUNT(oi.ID) AS count
        FROM ORDER_ITEMS oi
            JOIN ORDERS o ON oi.ORDER_ID = o.ID
            JOIN DOSIRAK d ON oi.DOSIRAK_ID = d.ID
        WHERE o.ARRIVAL_AT = #{arrive}
            AND o.UNIVERSITY_ID = #{universityId}
        GROUP BY d.ID, d.NAME, d.PRICE

        UNION ALL

        -- 2. dosirakId 주문 이력이 없을 경우만 추가
        SELECT
            d.ID AS dosirakId,
            d.NAME AS name,
            d.PRICE AS price,
            (
                SELECT MIN(dc.NAME)
                FROM DOSIRAK_CATEGORY_MAP dcm
                JOIN DOSIRAK_CATEGORY dc ON dcm.DOSIRAK_CATEGORY_ID = dc.ID
                WHERE dcm.DOSIRAK_ID = d.ID
            ) AS category,
            0 AS count
        FROM DOSIRAK d
        WHERE d.ID = #{dosirakId}
            AND NOT EXISTS (
                SELECT 1
                FROM ORDER_ITEMS oi
                JOIN ORDERS o ON oi.ORDER_ID = o.ID
            WHERE oi.DOSIRAK_ID = #{dosirakId}
                AND o.ARRIVAL_AT = #{arrive}
                AND o.UNIVERSITY_ID = #{universityId}
        )

        ORDER BY dosirakId
    </select>



</mapper>