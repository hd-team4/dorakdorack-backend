<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dorakdorak.domain.dosirak.mapper.DosirakMapper">

    <select id="findDosiraks" parameterType="map" resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
        SELECT *
        FROM (
            SELECT D.ID AS dosirakId,
            D.NAME AS name,
            D.PRICE AS price,
            D.SALE_PERCENTAGE AS salesPercentage,
            D.STORAGE_TYPE AS storageType,
            (
                SELECT IMAGE_URL
                FROM DOSIRAK_IMAGE
                WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
                FETCH FIRST 1 ROWS ONLY
            ) AS imageUrl,
            ROWNUM AS rn
        FROM (
                SELECT DISTINCT DOSIRAK.*
                FROM DOSIRAK
                    JOIN DOSIRAK_CATEGORY_MAP DCM ON DOSIRAK.ID = DCM.DOSIRAK_ID
                    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
                <where>
                    <if test="filterType != 'ALL'">
                        DC.NAME = #{filterType}
                    </if>
                </where>
        ) D
        <choose>
            <when test="sortType == 'LATEST'">
                ORDER BY D.CREATED_AT DESC
            </when>
            <when test="sortType == 'POPULAR'">
                ORDER BY (
                    SELECT COUNT(*)
                    FROM ORDER_ITEMS OI
                    WHERE OI.NAME = D.NAME
                ) DESC
            </when>
            <when test="sortType == 'priceASC'">
                ORDER BY D.PRICE * (1 - D.SALE_PERCENTAGE) ASC
            </when>
            <when test="sortType == 'priceDESC'">
                ORDER BY D.PRICE * (1 - D.SALE_PERCENTAGE) DESC
            </when>
        </choose>
        ) TMP
        <where>
            <if test="dosirakId != null">
                TMP.dosirakId &gt; #{dosirakId}
            </if>
            <if test="true">
                AND ROWNUM &lt;= 12
            </if>
        </where>
    </select>

    <select id="findCustomDosiraksByMemberId" resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakResponseDto">
        SELECT
            D.NAME AS NAME,
            DI.IMAGE_URL AS IMAGE_URL,
            D.CREATED_AT AS CREATED_AT
        FROM DOSIRAK D
            JOIN DOSIRAK_IMAGE DI
                ON D.ID = DI.DOSIRAK_ID
        WHERE D.CREATED_BY = #{memberId}
            AND IS_CUSTOM = 'CUSTOM'
    </select>

    <select id="findCustomDosiraksPreviewByMemberId" resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakResponseDto">
        SELECT
            NAME,
            IMAGE_URL,
            CREATED_AT
        FROM (
            SELECT
                D.NAME AS NAME,
                DI.IMAGE_URL AS IMAGE_URL,
                D.CREATED_AT AS CREATED_AT
            FROM DOSIRAK D
                JOIN DOSIRAK_IMAGE DI
                    ON D.ID = DI.DOSIRAK_ID
            WHERE D.CREATED_BY = #{memberId}
                AND IS_CUSTOM = 'CUSTOM'
            ORDER BY CREATED_AT DESC
        )
        WHERE ROWNUM &lt;= 3
    </select>

    <select id="countCustomDosiraksByMemberId" resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakAmountResponseDto">
        SELECT COUNT(*) AS DOSIRAK_AMOUNT
        FROM DOSIRAK
        WHERE CREATED_BY = #{memberId}
            AND IS_CUSTOM = 'CUSTOM'
    </select>
</mapper>