<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dorakdorak.domain.dosirak.mapper.DosirakMapper">

  -- 최신순 정렬
  <select id="findDosiraksOrderByCreatedAt" parameterType="map"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
    SELECT * FROM (
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
    FETCH FIRST 1 ROWS ONLY
    ) AS IMAGE_URL,
    D.CREATED_AT,
    ROW_NUMBER() OVER (ORDER BY D.CREATED_AT DESC) AS RN
    FROM DOSIRAK D
    JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
    <where>
      D.IS_CUSTOM = #{dosirakType}
      <if test="filterType != 'ALL'">
        AND DC.NAME = #{filterType}
      </if>
      <if test="dosirakId != null">
        AND D.CREATED_AT &lt; (
        SELECT CREATED_AT FROM DOSIRAK WHERE ID = #{dosirakId}
        )
      </if>
    </where>
    )
    WHERE RN &lt;= #{count}
  </select>

  -- 인기순 정렬 (일반 도시락)
  <select id="findNormalDosiraksOrderByPopularity" parameterType="map"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
    SELECT * FROM (
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
    FETCH FIRST 1 ROWS ONLY
    ) AS IMAGE_URL,
    (
    SELECT COUNT(*) FROM ORDER_ITEMS OI WHERE OI.DOSIRAK_ID = D.ID
    ) AS ORDER_COUNT,
    ROW_NUMBER() OVER (
    ORDER BY (
    SELECT COUNT(*) FROM ORDER_ITEMS OI WHERE OI.DOSIRAK_ID = D.ID
    ) DESC
    ) AS RN
    FROM DOSIRAK D
    JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
    <where>
      D.IS_CUSTOM = 'NORMAL'
      <if test="filterType != 'ALL'">
        AND DC.NAME = #{filterType}
      </if>
      <if test="dosirakId != null">
        AND (
        SELECT COUNT(*) FROM ORDER_ITEMS WHERE DOSIRAK_ID = D.ID
        ) &lt; (
        SELECT COUNT(*) FROM ORDER_ITEMS WHERE DOSIRAK_ID = #{dosirakId}
        )
      </if>
    </where>
    )
    WHERE RN &lt;= #{count}
  </select>

  -- 인기순 정렬 (커스텀 도시락)
  <select id="findCustomDosiraksOrderByPopularity" parameterType="map"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
    SELECT *
    FROM (
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL
    FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
    FETCH FIRST 1 ROWS ONLY
    ) AS IMAGE_URL,
    ROW_NUMBER() OVER (
    ORDER BY (
    SELECT COUNT(*)
    FROM CUSTOM_DOSIRAK_VOTE V
    WHERE V.CUSTOM_DOSIRAK_ID = D.ID
    ) DESC, D.ID ASC
    ) AS RN
    FROM DOSIRAK D
    JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
    <where>
      D.IS_CUSTOM = 'CUSTOM'
      <if test="filterType != 'ALL'">
        AND DC.NAME = #{filterType}
      </if>
    </where>
    )
    <where>
      <if test="dosirakId != null">
        RN > (
        SELECT NVL(MIN(RN), 0)
        FROM (
        SELECT
        D.ID,
        ROW_NUMBER() OVER (
        ORDER BY (
        SELECT COUNT(*) FROM CUSTOM_DOSIRAK_VOTE V
        WHERE V.CUSTOM_DOSIRAK_ID = D.ID
        ) DESC, D.ID ASC
        ) AS RN
        FROM DOSIRAK D
        JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
        JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
        <where>
          D.IS_CUSTOM = 'CUSTOM'
          <if test="filterType != 'ALL'">
            AND DC.NAME = #{filterType}
          </if>
          AND D.ID = #{dosirakId}
        </where>
        )
        )
      </if>
    </where>
    FETCH FIRST #{count} ROWS ONLY
  </select>

  -- 가격 오름차순
  <select id="findDosiraksOrderByPriceAsc" parameterType="map"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
    SELECT * FROM (
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
    FETCH FIRST 1 ROWS ONLY
    ) AS IMAGE_URL,
    ROW_NUMBER() OVER (
    ORDER BY D.PRICE * (1 - D.SALE_PERCENTAGE) ASC
    ) AS RN
    FROM DOSIRAK D
    JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
    <where>
      D.IS_CUSTOM = #{dosirakType}
      <if test="filterType != 'ALL'">
        AND DC.NAME = #{filterType}
      </if>
      <if test="dosirakId != null">
        AND D.PRICE * (1 - D.SALE_PERCENTAGE) &gt; (
        SELECT PRICE * (1 - SALE_PERCENTAGE) FROM DOSIRAK WHERE ID = #{dosirakId}
        )
      </if>
    </where>
    )
    WHERE RN &lt;= #{count}
  </select>

  -- 가격 내림차순
  <select id="findDosiraksOrderByPriceDesc" parameterType="map"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakResponseDto">
    SELECT * FROM (
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID AND IMAGE_TYPE = 'MAIN'
    FETCH FIRST 1 ROWS ONLY
    ) AS IMAGE_URL,
    ROW_NUMBER() OVER (
    ORDER BY D.PRICE * (1 - D.SALE_PERCENTAGE) DESC
    ) AS RN
    FROM DOSIRAK D
    JOIN DOSIRAK_CATEGORY_MAP DCM ON D.ID = DCM.DOSIRAK_ID
    JOIN DOSIRAK_CATEGORY DC ON DC.ID = DCM.DOSIRAK_CATEGORY_ID
    <where>
      D.IS_CUSTOM = #{dosirakType}
      <if test="filterType != 'ALL'">
        AND DC.NAME = #{filterType}
      </if>
      <if test="dosirakId != null">
        AND D.PRICE * (1 - D.SALE_PERCENTAGE) &lt; (
        SELECT PRICE * (1 - SALE_PERCENTAGE) FROM DOSIRAK WHERE ID = #{dosirakId}
        )
      </if>
    </where>
    )
    WHERE RN &lt;= #{count}
  </select>

  --도시락 상세

  <select id="findDosirakDetail" parameterType="long"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakDetailResponse">
    SELECT
    D.ID AS DOSIRAK_ID,
    D.NAME AS NAME,
    D.PRICE AS PRICE,
    D.SALE_PERCENTAGE AS SALE_PERCENTAGE,
    D.WEIGHT AS WEIGHT,
    D.STORAGE_TYPE AS STORAGE_TYPE,
    (
    SELECT IMAGE_URL
    FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = D.ID
    AND IMAGE_TYPE = 'MAIN'
    ) AS THUMBNAIL_IMAGE_URL
    FROM DOSIRAK D
    WHERE D.ID = #{dosirakId}
  </select>

  <select id="findDetailImages" parameterType="long"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakDetailImageResponseDto">
    SELECT
    IMAGE_URL AS IMAGE_URL,
    SORT_ORDER AS SORT_ORDER
    FROM DOSIRAK_IMAGE
    WHERE DOSIRAK_ID = #{dosirakId}
    AND IMAGE_TYPE = 'SUB'
    ORDER BY SORT_ORDER
  </select>

  <select id="findNutrition" parameterType="long"
    resultType="dorakdorak.domain.dosirak.dto.response.DosirakNutritionResponseDto">
    SELECT
    CALORIES,
    CARBOHYDRATES,
    SUGARS,
    PROTEIN,
    CHOLESTEROL,
    FAT,
    TRANS_FAT
    FROM NUTRITION
    WHERE DOSIRAK_ID = #{dosirakId}
  </select>

  --커스텀 도시락

  <select id="findCustomDosiraksByMemberId"
    resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakResponseDto">
    SELECT
    D.NAME AS NAME,
    DI.IMAGE_URL AS IMAGE_URL,
    D.CREATED_AT AS CREATED_AT
    FROM DOSIRAK D
    JOIN DOSIRAK_IMAGE DI
    ON D.ID = DI.DOSIRAK_ID
    WHERE D.CREATED_BY = #{memberId}
    AND IS_CUSTOM = 'CUSTOM'
  </select>

  <select id="findCustomDosiraksPreviewByMemberId"
    resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakResponseDto">
    SELECT
    NAME,
    IMAGE_URL,
    CREATED_AT
    FROM (
    SELECT
    D.NAME AS NAME,
    DI.IMAGE_URL AS IMAGE_URL,
    D.CREATED_AT AS CREATED_AT
    FROM DOSIRAK D
    JOIN DOSIRAK_IMAGE DI
    ON D.ID = DI.DOSIRAK_ID
    WHERE D.CREATED_BY = #{memberId}
    AND IS_CUSTOM = 'CUSTOM'
    ORDER BY CREATED_AT DESC
    )
    WHERE ROWNUM &lt;= 3
  </select>

  <select id="countCustomDosiraksByMemberId"
    resultType="dorakdorak.domain.dosirak.dto.response.MyCustomDosirakAmountResponseDto">
    SELECT COUNT(*) AS DOSIRAK_AMOUNT
    FROM DOSIRAK
    WHERE CREATED_BY = #{memberId}
    AND IS_CUSTOM = 'CUSTOM'
  </select>
</mapper>